# 圖表視覺化功能使用指南

## 功能概述

未實現損益 APP 現在具備完整的圖表視覺化功能，讓您能夠直觀地追蹤損益變化趨勢。系統會自動記錄歷史數據並生成互動式圖表，幫助您更好地分析投資績效。

---

## 📊 總損益趨勢圖

### 如何開啟

點擊畫面頂端的**總損益卡片**（顯示總損益金額的大型卡片），即可展開或收合總損益趨勢圖。卡片上會顯示「📈 顯示圖表」或「📊 隱藏圖表」提示。

### 圖表內容

總損益趨勢圖顯示所有持股的總損益隨時間變化的曲線。圖表採用藍色線條，清晰呈現損益波動。

**圖表元素**：
- **X 軸**：時間（格式為「時:分」）
- **Y 軸**：損益金額（自動格式化為千分位）
- **曲線**：藍色線條代表總損益變化

### 互動功能

將滑鼠移動到圖表上的任意點，會顯示詳細的 Tooltip 資訊：
- 精確的日期時間（年/月/日 時:分:秒）
- 該時間點的損益金額（紅色代表獲利，綠色代表虧損）

### 資料記錄機制

系統會**每分鐘自動記錄一次**總損益數據，並保留最近 100 筆記錄。這意味著您可以查看大約過去 100 分鐘（約 1.5 小時）的損益變化。

**注意事項**：
- 資料會同步至雲端 Firestore，關閉 APP 後重新開啟仍可看到歷史數據
- 如果沒有持股，則不會記錄數據
- 圖表至少需要 2 筆數據點才能正常顯示

---

## 📈 個股損益曲線圖

### 如何開啟

每張股票卡片的右下角都有一個圖表按鈕（📈 或 📊）。點擊該按鈕即可展開或收合該股票的損益曲線圖。

**按鈕狀態**：
- **📈**：圖表已收合，點擊展開
- **📊**：圖表已展開，點擊收合

### 圖表內容

個股損益曲線圖顯示單一股票的損益隨時間變化。圖表顏色會根據當前損益狀態自動調整：
- **紅色曲線**：目前處於獲利狀態
- **綠色曲線**：目前處於虧損狀態

**圖表元素**：
- **X 軸**：時間（格式為「時:分」）
- **Y 軸**：損益金額（自動格式化為千分位）
- **曲線**：動態顏色線條代表該股票的損益變化

### 互動功能

將滑鼠移動到圖表上的任意點，會顯示詳細的 Tooltip 資訊：
- 精確的日期時間
- 該時間點的損益金額（顏色與損益狀態同步）
- **該時間點的股價**（藍色顯示）

這個功能特別有用，因為您可以看到在特定價格下的損益狀況，幫助您判斷未來的買賣時機。

### 資料記錄機制

每檔股票的歷史數據是獨立記錄的。系統會在以下情況記錄數據：
- **WebSocket 接收到新報價時**，如果距離上次記錄超過 1 分鐘，則記錄新數據
- 每筆記錄包含：時間、損益、股價

同樣保留最近 100 筆記錄，讓您可以查看該股票過去的損益波動。

**注意事項**：
- 新增股票時，歷史記錄為空，需要等待 WebSocket 開始接收報價後才會開始記錄
- 編輯買價或張數後，損益計算會改變，但歷史記錄中的損益數值不會追溯更新
- 資料會同步至雲端，所有裝置共享相同的歷史記錄

---

## 🎨 圖表設計特色

### 深色主題

所有圖表都採用與 APP 一致的深色主題設計：
- 黑色背景（#0d0d0d 或 #111）
- 灰色網格線（#333）
- 灰色軸線和標籤（#888）
- 高對比度的曲線顏色

### 響應式設計

圖表會自動適應螢幕寬度，無論在手機、平板或電腦上都能完美顯示。圖表高度固定：
- 總損益圖表：250px
- 個股圖表：200px

### 自訂 Tooltip

Tooltip 採用深色半透明背景，清晰顯示資訊而不遮擋圖表。文字大小和顏色經過精心調整，確保易讀性。

---

## 💡 使用技巧

### 1. 快速檢視總體表現

開啟總損益趨勢圖，可以一眼看出今天的損益是否穩定上升或下降。如果曲線波動劇烈，代表持股價格變動較大。

### 2. 對比個股表現

同時展開多檔股票的圖表，可以對比哪些股票的損益波動較大，哪些較為穩定。這有助於調整持股配置。

### 3. 找出最佳賣點

查看個股圖表時，如果發現某個時間點的損益達到高峰後開始回落，可以參考該時間點的股價，作為未來設定賣出目標價的依據。

### 4. 分析損益與價格關係

個股圖表的 Tooltip 會同時顯示損益和股價。透過觀察不同價格下的損益變化，您可以更精確地計算出理想的賣出價格。

### 5. 長期追蹤

雖然目前只保留最近 100 筆記錄，但如果您持續開啟 APP，系統會不斷更新歷史數據。建議在交易時段定期查看，累積更多數據點。

---

## 🔧 技術細節

### 使用的圖表庫

本功能使用 **Recharts** 圖表庫，這是一個基於 React 的輕量級圖表解決方案，具有以下優點：
- 完全響應式設計
- 豐富的互動功能
- 易於自訂樣式
- 效能優異

### 資料儲存結構

**總損益歷史**：
```javascript
{
  time: "2026-01-04T14:30:00.000Z",
  profit: 12345
}
```

**個股歷史**：
```javascript
{
  time: "2026-01-04T14:30:00.000Z",
  profit: 5678,
  price: 580.5
}
```

所有歷史數據都儲存在 Firestore 中：
- 總損益歷史：`users/{USER_DOC_ID}/totalHistory`
- 個股歷史：`users/{USER_DOC_ID}/stocks[i]/history`

### 效能優化

為了避免過度頻繁的資料寫入，系統採用以下策略：
- 每分鐘最多記錄一次數據
- 自動清理超過 100 筆的舊記錄
- 使用 Firestore 的 merge 模式避免覆蓋其他資料

---

## ⚠️ 注意事項

### 資料保留期限

目前系統只保留最近 100 筆記錄。如果您希望長期保存歷史數據，建議定期匯出（未來版本將提供匯出功能）。

### 網路連線需求

圖表功能依賴 WebSocket 即時報價和 Firestore 同步。如果網路不穩定，可能會出現：
- 資料記錄中斷
- 圖表更新延遲
- 部分數據點遺失

### 瀏覽器相容性

Recharts 支援所有現代瀏覽器（Chrome、Firefox、Safari、Edge）。如果您使用較舊的瀏覽器，圖表可能無法正常顯示。

### 手機觸控操作

在手機上，您可以用手指觸碰圖表來查看 Tooltip。但由於螢幕較小，建議橫向顯示以獲得更好的閱讀體驗。

---

## 🚀 未來改進計畫

以下功能正在規劃中：

1. **更長的歷史記錄**：增加保留筆數或提供自訂選項
2. **時間範圍選擇**：可選擇查看今日、本週、本月的數據
3. **多圖表對比**：在同一畫面對比多檔股票的表現
4. **圖表匯出**：將圖表儲存為圖片或 PDF
5. **技術指標**：加入移動平均線、RSI 等技術分析工具
6. **價格警示線**：在圖表上標示目標價或停損價

---

## 📞 問題回報

如果您在使用圖表功能時遇到任何問題（例如圖表無法顯示、數據不正確、效能問題），歡迎透過 GitHub Issues 回報。請提供以下資訊：
- 使用的瀏覽器和版本
- 錯誤截圖或描述
- 操作步驟

我們會盡快協助您解決問題！
